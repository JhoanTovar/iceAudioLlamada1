class AudioManager{constructor(){this.audioContext=null,this.mediaStream=null,this.liveProcessor=null,this.liveSendBuffer=[],this.messageStream=null,this.messageProcessor=null,this.messageBuffer=[],this.bufferQueue=[],this.isPlaying=!1,this.currentCall=null,this.SAMPLE_RATE=44100,this.BUFFER_SIZE=2048,this.SEND_THRESHOLD=8,this.isInitializing=!1}async initAudio(){try{return this.isInitializing?(console.log("[AudioManager] Ya se está inicializando, esperando..."),await new Promise(e=>setTimeout(e,100)),null!==this.audioContext):(this.isInitializing=!0,this.audioContext&&"closed"===this.audioContext.state&&(console.log("[AudioManager] AudioContext cerrado, creando nuevo..."),this.audioContext=null),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.SAMPLE_RATE=this.audioContext.sampleRate,console.log(`[AudioManager] Usando frecuencia nativa del dispositivo: ${this.SAMPLE_RATE} Hz`)),"suspended"===this.audioContext.state&&await this.audioContext.resume(),this.isInitializing=!1,console.log("[AudioManager] AudioContext inicializado correctamente, estado:",this.audioContext.state),!0)}catch(e){return this.isInitializing=!1,console.error("[AudioManager] Error al inicializar AudioContext:",e),!1}}async ensureAudioContextReady(){return this.audioContext&&"closed"!==this.audioContext.state?"suspended"===this.audioContext.state&&await this.audioContext.resume():await this.initAudio(),this.audioContext&&"running"===this.audioContext.state}async startRecordingMessage(){if(!await this.ensureAudioContextReady()&&!await this.initAudio())return!1;try{await this.audioContext.resume(),this.messageStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});const e=this.audioContext.createMediaStreamSource(this.messageStream);return this.messageProcessor=this.audioContext.createScriptProcessor(this.BUFFER_SIZE,1,1),e.connect(this.messageProcessor),this.messageProcessor.connect(this.audioContext.destination),this.messageBuffer=[],this.messageProcessor.onaudioprocess=e=>{const t=e.inputBuffer.getChannelData(0),a=this.applySoftCompression(t),i=this.floatToPCM16(a);this.messageBuffer.push(i)},console.log("[AudioManager] Grabación de mensaje iniciada"),!0}catch(e){return console.error("[AudioManager] Error al iniciar grabación de mensaje:",e),!1}}async stopRecordingMessage(){try{this.messageProcessor&&(this.messageProcessor.disconnect(),this.messageProcessor.onaudioprocess=null,this.messageProcessor=null),this.messageStream&&(this.messageStream.getTracks().forEach(e=>e.stop()),this.messageStream=null);const e=this.mergePCM(this.messageBuffer),t=new Uint8Array(e.buffer),a=this.messageBuffer.length*this.BUFFER_SIZE/this.SAMPLE_RATE;return this.messageBuffer=[],console.log("[AudioManager] Grabación de mensaje detenida"),{pcm16:t,duration:Math.round(a),timestamp:(new Date).toISOString()}}catch(e){return console.error("[AudioManager] Error al detener grabación de mensaje:",e),null}}cancelRecordingMessage(){try{return this.messageProcessor&&(this.messageProcessor.disconnect(),this.messageProcessor.onaudioprocess=null,this.messageProcessor=null),this.messageStream&&(this.messageStream.getTracks().forEach(e=>e.stop()),this.messageStream=null),this.messageBuffer=[],console.log("[AudioManager] Grabación de mensaje cancelada"),!0}catch(e){return console.error("[AudioManager] Error al cancelar grabación:",e),!1}}async startLiveRecording(){try{await this.ensureAudioContextReady(),this.mediaStream||(this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}));const e=this.audioContext.createMediaStreamSource(this.mediaStream),t=this.audioContext.createGain();return t.gain.value=.5,this.liveProcessor=this.audioContext.createScriptProcessor(this.BUFFER_SIZE,1,1),e.connect(t),t.connect(this.liveProcessor),this.liveProcessor.connect(this.audioContext.destination),this.liveSendBuffer=[],this.liveProcessor.onaudioprocess=e=>{if(!this.currentCall||!window.IceDelegate)return;const t=e.inputBuffer.getChannelData(0),a=this.applySoftCompression(t),i=this.floatToPCM16(a);if(this.liveSendBuffer.push(i),this.liveSendBuffer.length>=this.SEND_THRESHOLD){const e=this.mergePCM(this.liveSendBuffer);this.liveSendBuffer=[];const t=new Uint8Array(e.buffer);this.currentCall.isGroup?window.IceDelegate.sendAudioGroup(this.currentCall.groupId,t):window.IceDelegate.sendAudio(t)}},console.log("[AudioManager] Grabación en vivo iniciada"),!0}catch(e){return console.error("[AudioManager] Error al iniciar grabación en vivo:",e),!1}}stopLiveRecording(){try{if(this.liveSendBuffer.length>0&&this.currentCall&&window.IceDelegate){const e=this.mergePCM(this.liveSendBuffer),t=new Uint8Array(e.buffer);this.currentCall.isGroup?window.IceDelegate.sendAudioGroup(this.currentCall.groupId,t):window.IceDelegate.sendAudio(t),this.liveSendBuffer=[]}return this.liveProcessor&&(this.liveProcessor.disconnect(),this.liveProcessor.onaudioprocess=null,this.liveProcessor=null),this.mediaStream&&(this.mediaStream.getTracks().forEach(e=>e.stop()),this.mediaStream=null),console.log("[AudioManager] Grabación en vivo detenida"),!0}catch(e){return console.error("[AudioManager] Error al detener grabación en vivo:",e),!1}}async initiateCall(e,t,a=!1){try{return await this.initAudio()&&await window.IceDelegate.startCall(e)?(this.currentCall={id:`call_${Date.now()}`,recipientId:e,recipientName:t,startTime:Date.now(),isGroup:!1},console.log("[AudioManager] Llamada individual iniciada con:",t),this.currentCall):null}catch(e){return console.error("[AudioManager] Error al iniciar llamada:",e),null}}async answerCall(e){try{return!!await this.initAudio()&&(!!await window.IceDelegate.acceptCall(e)&&(await this.startLiveRecording(),console.log("[AudioManager] Llamada individual respondida"),!0))}catch(e){return console.error("[AudioManager] Error al responder llamada:",e),!1}}async rejectCall(e){try{return window.IceDelegate&&await window.IceDelegate.rejectCall(e),this.currentCall&&(this.currentCall=null),console.log("[AudioManager] Llamada individual rechazada"),!0}catch(e){return console.error("[AudioManager] Error al rechazar llamada:",e),!1}}async initiateGroupCall(e,t){try{if(!await this.initAudio())return null;const e=await window.IceDelegate.createGroupCall(t);return e?(this.currentCall={id:`group_call_${Date.now()}`,groupId:e,members:t,startTime:Date.now(),isGroup:!0},await this.startLiveRecording(),console.log("[AudioManager] Llamada grupal iniciada:",e),this.currentCall):null}catch(e){return console.error("[AudioManager] Error al iniciar llamada grupal:",e),null}}async answerGroupCall(e){try{return!!await this.initAudio()&&(await window.IceDelegate.joinGroupCall(e),await this.startLiveRecording(),console.log("[AudioManager] Llamada grupal respondida:",e),!0)}catch(e){return console.error("[AudioManager] Error al responder llamada grupal:",e),!1}}async rejectGroupCall(e){try{return window.IceDelegate&&await window.IceDelegate.leaveGroupCall(e),this.currentCall&&(this.currentCall=null),console.log("[AudioManager] Llamada grupal rechazada"),!0}catch(e){return console.error("[AudioManager] Error al rechazar llamada grupal:",e),!1}}async endCall(){if(this.currentCall){const e=(Date.now()-this.currentCall.startTime)/1e3;if(this.currentCall.duration=e,window.IceDelegate)if(this.currentCall.isGroup)await window.IceDelegate.leaveGroupCall(this.currentCall.groupId);else{const e=this.currentCall.recipientId||this.currentCall.callerId;e&&await window.IceDelegate.colgar(e)}console.log(`[AudioManager] Llamada ${this.currentCall.isGroup?"grupal":"individual"} finalizada. Duración:`,e,"segundos"),this.currentCall=null}this.stopLiveRecording(),this.bufferQueue=[],this.isPlaying=!1}applySoftCompression(e){const t=.65,a=new Float32Array(e.length);for(let i=0;i<e.length;i++){let r=e[i];Math.abs(r)>t&&(r=Math.sign(r)*(t+(Math.abs(r)-t)/4)),a[i]=r}return a}mergePCM(e){const t=e.reduce((e,t)=>e+t.length,0),a=new Int16Array(t);let i=0;for(const t of e)a.set(t,i),i+=t.length;return a}floatToPCM16(e){const t=new Int16Array(e.length);for(let a=0;a<e.length;a++){const i=Math.max(-1,Math.min(1,e[a]));t[a]=i<0?32768*i:32767*i}return t}convertPCM16ToFloat32(e){const t=new DataView(e.buffer),a=new Float32Array(e.byteLength/2);for(let e=0;e<a.length;e++)a[e]=t.getInt16(2*e,!0)/32768;return a}async playAudio(e){if(console.log("[DEBUG] AUDIOMANAGER.PLAYAUDIO EJECUTADO"),console.log(`[DEBUG] Bytes recibidos: ${e?.length||0}`),!e||0===e.length)return void console.error(" [DEBUG] No hay bytes para reproducir");if(!await this.ensureAudioContextReady())return void console.error("[DEBUG] No se pudo preparar AudioContext");console.log(`[DEBUG] AudioContext estado: ${this.audioContext.state}`);const t=this.convertPCM16ToFloat32(e);this.bufferQueue.push(t),this.isPlaying||this.processQueue()}processQueue(){if(0===this.bufferQueue.length)return void(this.isPlaying=!1);this.isPlaying=!0;const e=this.bufferQueue.shift();try{const t=this.audioContext.createBuffer(1,e.length,this.SAMPLE_RATE);t.getChannelData(0).set(e);const a=this.audioContext.createBufferSource();a.buffer=t,a.connect(this.audioContext.destination),a.start(),a.onended=()=>this.processQueue()}catch(e){console.error("[AudioManager] Error reproduciendo audio:",e),this.isPlaying=!1}}}"undefined"!=typeof window&&(window.AudioManager=new AudioManager,window.IceDelegate&&window.IceDelegate.subscribe(e=>{window.AudioManager.playAudio(e)}));