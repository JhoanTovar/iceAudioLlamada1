const UI={loginScreen:null,chatScreen:null,usernameInput:null,loginBtn:null,registerBtn:null,loginError:null,currentUsername:null,logoutBtn:null,usersList:null,groupsList:null,welcomeScreen:null,chatArea:null,chatTitle:null,chatSubtitle:null,messagesContainer:null,messageInput:null,sendBtn:null,searchInput:null,tabButtons:null,chatsTab:null,groupsTab:null,createGroupModal:null,groupNameInput:null,confirmGroupBtn:null,cancelGroupBtn:null,groupError:null,addMembersModal:null,membersListContainer:null,confirmMembersBtn:null,cancelMembersBtn:null,membersError:null,historyModal:null,historyModalTitle:null,historyMessagesContainer:null,closeHistoryBtn:null,recordingModal:null,recordingModalTime:null,recordingChatType:null,stopRecordingBtn:null,cancelRecordingBtn:null,recordingIndicator:null,callBtn:null,sendAudioBtn:null,incomingCallModal:null,activeCallModal:null,rejectCallBtn:null,answerCallBtn:null,endCallBtn:null,muteBtn:null,callerNameElement:null,callTitleElement:null,callDurationElement:null,callAvatarLargeElement:null,currentChatType:null,currentChatId:null,currentGroup:null,previousGroupId:null,allUsers:[],recordingTime:0,init(){console.log("üé® Inicializando UI..."),this.loginScreen=document.getElementById("login-screen"),this.chatScreen=document.getElementById("chat-screen"),this.usernameInput=document.getElementById("username-input"),this.loginBtn=document.getElementById("login-btn"),this.registerBtn=document.getElementById("register-btn"),this.loginError=document.getElementById("login-error"),this.currentUsername=document.getElementById("current-username"),this.logoutBtn=document.getElementById("logout-btn"),this.usersList=document.getElementById("users-list"),this.groupsList=document.getElementById("groups-list"),this.welcomeScreen=document.getElementById("welcome-screen"),this.chatArea=document.getElementById("chat-area"),this.chatTitle=document.getElementById("chat-title"),this.chatSubtitle=document.getElementById("chat-subtitle"),this.messagesContainer=document.getElementById("messages-container"),this.messageInput=document.getElementById("message-input"),this.sendBtn=document.getElementById("send-btn"),this.searchInput=document.getElementById("search-input"),this.tabButtons=document.querySelectorAll(".tab-btn"),this.chatsTab=document.getElementById("chats-tab"),this.groupsTab=document.getElementById("groups-tab"),this.createGroupModal=document.getElementById("create-group-modal"),this.groupNameInput=document.getElementById("group-name-input"),this.confirmGroupBtn=document.getElementById("confirm-group-btn"),this.cancelGroupBtn=document.getElementById("cancel-group-btn"),this.groupError=document.getElementById("group-error"),this.addMembersModal=document.getElementById("add-members-modal"),this.membersListContainer=document.getElementById("members-list"),this.confirmMembersBtn=document.getElementById("confirm-members-btn"),this.cancelMembersBtn=document.getElementById("cancel-members-btn"),this.membersError=document.getElementById("members-error"),this.historyModal=document.getElementById("history-modal"),this.historyModalTitle=document.getElementById("history-modal-title"),this.historyMessagesContainer=document.getElementById("history-messages-container"),this.closeHistoryBtn=document.getElementById("close-history-btn"),this.recordingModal=document.getElementById("recording-modal"),this.recordingModalTime=document.getElementById("recording-modal-time"),this.recordingChatType=document.getElementById("recording-chat-type"),this.stopRecordingBtn=document.getElementById("stop-recording-btn"),this.cancelRecordingBtn=document.getElementById("cancel-recording-btn"),this.recordingIndicator=document.getElementById("recording-indicator"),this.callBtn=document.getElementById("call-btn"),this.sendAudioBtn=document.getElementById("send-audio-btn"),this.incomingCallModal=document.getElementById("incoming-call-modal"),this.activeCallModal=document.getElementById("active-call-modal"),this.rejectCallBtn=document.getElementById("reject-call-btn"),this.answerCallBtn=document.getElementById("answer-call-btn"),this.endCallBtn=document.getElementById("end-call-btn"),this.muteBtn=document.getElementById("mute-btn"),this.callerNameElement=document.getElementById("caller-name"),this.callTitleElement=document.getElementById("call-title"),this.callDurationElement=document.getElementById("call-duration"),this.callAvatarLargeElement=document.querySelector(".call-avatar-large"),this.setupTabSwitching(),this.setupModalClose(),console.log("‚úÖ UI inicializada correctamente")},setupTabSwitching(){this.tabButtons.forEach(e=>{e.addEventListener("click",()=>this.switchTab(e.dataset.tab))})},setupModalClose(){document.querySelectorAll(".modal-close").forEach(e=>{e.addEventListener("click",()=>{this.createGroupModal.classList.remove("active"),this.addMembersModal.classList.remove("active"),this.historyModal.classList.remove("active")})}),this.closeHistoryBtn&&this.closeHistoryBtn.addEventListener("click",()=>{this.historyModal.classList.remove("active")})},showLoginScreen(){this.loginScreen.classList.add("active"),this.chatScreen.classList.remove("active"),this.usernameInput.value="",this.hideError(this.loginError)},showChatScreen(){this.loginScreen.classList.remove("active"),this.chatScreen.classList.add("active")},switchTab(e){this.tabButtons.forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),this.chatsTab.classList.toggle("active","chats"===e),this.groupsTab.classList.toggle("active","groups"===e)},setCurrentUser(e){this.currentUsername.textContent=e.username;const t=document.querySelector(".user-avatar");t&&(t.textContent=e.username.charAt(0).toUpperCase())},renderUsers(e,t){this.usersList.innerHTML="",this.allUsers=e.map(e=>"string"==typeof e?{id:null,username:e}:{id:e.id,username:"string"==typeof e.username?e.username:e.name||"Usuario",online:e.online||!1});const n=this.allUsers.filter(e=>e.id!==t);0!==n.length?n.forEach(e=>{const t=document.createElement("div");t.className="list-item",t.dataset.userId=e.id;const n=document.createElement("div");n.className="item-avatar",n.textContent=e.username.charAt(0).toUpperCase();const s=document.createElement("div");s.className="item-info";const a=document.createElement("div");a.className="item-name",a.textContent=e.username;const l=document.createElement("div");l.className="item-status";const i=document.createElement("span");i.className="status-indicator "+(e.online?"online":"");const o=document.createTextNode(e.online?"En l√≠nea":"Desconectado");l.appendChild(i),l.appendChild(o),s.appendChild(a),s.appendChild(l),t.appendChild(n),t.appendChild(s),t.addEventListener("click",()=>this.openUserChat(e)),this.usersList.appendChild(t)}):this.usersList.innerHTML='<div class="empty-state">No hay usuarios disponibles</div>'},renderGroups(e){this.groupsList.innerHTML="",0!==e.length?e.forEach(e=>{const t=document.createElement("div");t.className="list-item",t.dataset.groupId=e.id;const n=document.createElement("div");n.className="item-avatar";const s=e.name||e.groupName||"Grupo";n.textContent=s.charAt(0).toUpperCase();const a=document.createElement("div");a.className="item-info";const l=document.createElement("div");l.className="item-name",l.textContent=s;const i=document.createElement("div");i.className="item-subtitle";const o=e.memberIds&&e.memberIds.length||e.members&&e.members.length||0;i.textContent=`${o} miembro${1!==o?"s":""}`,a.appendChild(l),a.appendChild(i),t.appendChild(n),t.appendChild(a),t.addEventListener("click",()=>this.openGroupChat(e)),this.groupsList.appendChild(t)}):this.groupsList.innerHTML='<div class="empty-state">No tienes grupos a√∫n</div>'},openUserChat(e){const t=window.AppController;if(t)t.openUserChatAndLoadHistory(e);else{this.currentChatType="user",this.currentChatId=e.id,this.currentGroup=null,this.welcomeScreen.style.display="none",this.chatArea.classList.remove("hidden"),this.chatTitle.textContent=e.username,this.chatSubtitle.textContent=e.online?"En l√≠nea":"Desconectado";const t=document.querySelector(".chat-avatar");t&&(t.textContent=e.username.charAt(0).toUpperCase());const n=document.getElementById("group-info-btn");n&&(n.style.display="none"),this.messagesContainer.innerHTML="",document.querySelectorAll("#users-list .list-item").forEach(e=>{e.classList.remove("active")});const s=document.querySelector(`#users-list .list-item[data-user-id="${e.id}"]`);s&&s.classList.add("active")}},openGroupChat(e){const t=window.AppController;if(t)this.currentGroup&&this.currentGroup.id!==e.id&&(this.previousGroupId=this.currentGroup.id,console.log(`[UI] Grupo anterior guardado: ${this.previousGroupId}`)),t.openGroupChatAndLoadHistory(e);else{this.currentChatType="group",this.currentChatId=e.id,this.currentGroup=e,this.welcomeScreen.style.display="none",this.chatArea.classList.remove("hidden");const t=e.name||e.groupName||"Grupo";this.chatTitle.textContent=t;const n=e.memberIds&&e.memberIds.length||e.members&&e.members.length||0;this.chatSubtitle.textContent=`${n} miembro${1!==n?"s":""}`;const s=document.querySelector(".chat-avatar");s&&(s.textContent=t.charAt(0).toUpperCase());const a=document.getElementById("group-info-btn");a&&(a.style.display="flex",a.onclick=()=>window.API.showAddMembersModal(e)),this.messagesContainer.innerHTML="",document.querySelectorAll("#groups-list .list-item").forEach(e=>{e.classList.remove("active")});const l=document.querySelector(`#groups-list .list-item[data-group-id="${e.id}"]`);l&&l.classList.add("active")}},renderMessages(e,t){console.log("renderMessages called with:",{messageCount:e?e.length:0,currentUserId:t,messages:e?e.slice(0,3):[]}),this.messagesContainer.innerHTML="",e&&0!==e.length?(e.filter(e=>"object"!=typeof e||null===e?(console.warn("Mensaje inv√°lido (no es objeto):",e),!1):!Array.isArray(e)||(console.warn("Mensaje inv√°lido (es array):",e),!1)).forEach((e,n)=>{console.log(`Processing message ${n}:`,e),this.appendMessage(e,t)}),this.scrollToBottom()):this.messagesContainer.innerHTML='<div class="empty-state">No hay mensajes a√∫n. ¬°Comienza la conversaci√≥n!</div>'},appendMessage(e,t){console.log(" appendMessage called with:",{message:e,currentUserId:t});const n=e.senderId===t,s=document.createElement("div");s.className="message "+(n?"sent":"received");const a=e.timestamp||e.startTime,l=a?new Date(a).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"}):"Sin hora";let i="";n||"group"!==this.currentChatType||(i=`<div class="message-sender">${e.senderUsername||"Usuario"}</div>`);let o="";o="AUDIO"===e.type||"audio"===e.type?'\n      <div class="audio-message">\n        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>\n          <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>\n          <line x1="12" y1="19" x2="12" y2="23"></line>\n          <line x1="8" y1="23" x2="16" y2="23"></line>\n        </svg>\n        <span class="audio-message-text">üé§ Mensaje de voz</span>\n      </div>\n    ':"CALL"===e.type||"call"===e.type?`\n      <div class="call-message">\n        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2196f3" stroke-width="2">\n          <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>\n        </svg>\n        <div class="call-message-info">\n          <span class="call-message-title"> Llamada ${e.status||"finalizada"}</span>\n          <span class="call-message-duration">Duraci√≥n: ${e.durationSeconds?`${Math.floor(e.durationSeconds/60)}:${(e.durationSeconds%60).toString().padStart(2,"0")}`:"0:00"}</span>\n        </div>\n      </div>\n    `:`\n      <div class="message-content">${this.escapeHtml(e.content||"")}</div>\n    `,s.innerHTML=`\n    ${i}\n    ${o}\n    <div class="message-time">${l}</div>\n  `,this.messagesContainer.appendChild(s)},appendAudioMessage(e,t){const n=e.senderId===t,s=document.createElement("div");s.className="message "+(n?"sent":"received");const a=new Date(e.timestamp).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"});let l="";n||"group"!==this.currentChatType||(l=`<div class="message-sender">${e.senderUsername||"Usuario"}</div>`);const i=`\n      <div class="audio-message">\n        <div class="audio-play-btn playing">\n          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <circle cx="12" cy="12" r="10"></circle>\n          </svg>\n        </div>\n        <span class="audio-duration">${e.duration||"0:00"}s</span>\n        <span class="audio-status">Mensaje de audio ${n?"enviado":"recibido"}</span>\n      </div>\n    `,o=document.createElement("div");o.className="message-bubble";const r=document.createElement("div");r.innerHTML=`\n      ${l}\n      ${i}\n      <div class="message-time">${a}</div>\n    `,o.appendChild(r),s.appendChild(o),this.messagesContainer.appendChild(s),this.scrollToBottom()},playAudioMessage(e,t){const n=new Audio(e);n.play(),t.disabled=!0,t.style.opacity="0.5",n.onended=()=>{t.disabled=!1,t.style.opacity="1"}},scrollToBottom(){this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight},clearMessageInput(){this.messageInput.value=""},showModal(){this.createGroupModal.classList.add("active"),this.groupNameInput.value="",this.hideError(this.groupError),this.groupNameInput.focus()},closeModal(){this.createGroupModal.classList.remove("active")},showAddMembersModal(e){this.addMembersModal.classList.add("active"),this.hideError(this.membersError),this.renderMemberSelection(e)},closeAddMembersModal(){this.addMembersModal.classList.remove("active")},renderMemberSelection(e){console.log("[UI] renderMemberSelection iniciado"),this.membersListContainer.innerHTML="";const t=window.API.getCurrentUser();if(!t)return console.error("[UI] No hay usuario actual"),void(this.membersListContainer.innerHTML='<div class="empty-state">Error: No se encontr√≥ usuario actual</div>');const n=(e.memberIds||e.members||[]).map(e=>"object"==typeof e&&void 0!==e.id?e.id:Number(e));if(!this.allUsers||0===this.allUsers.length)return console.error("[UI] allUsers est√° vac√≠o"),void(this.membersListContainer.innerHTML='<div class="empty-state">No se pudieron cargar los usuarios</div>');const s=this.allUsers.filter(e=>e.id!==t.id&&!n.includes(e.id));0!==s.length?s.forEach(e=>{const t=document.createElement("div");t.className="member-item";const n=document.createElement("input");n.type="checkbox",n.value=e.id,n.id=`member-${e.id}`;const s=document.createElement("label");s.htmlFor=`member-${e.id}`,s.textContent=e.username,t.appendChild(n),t.appendChild(s),this.membersListContainer.appendChild(t)}):this.membersListContainer.innerHTML='<div class="empty-state">No hay usuarios disponibles para agregar</div>'},getSelectedMembers(){const e=document.querySelectorAll("#members-list input[type='checkbox']:checked");return Array.from(e).map(e=>Number.parseInt(e.value))},showError(e,t){e&&(e.textContent=t,e.classList.add("active"))},hideError(e){e&&(e.textContent="",e.classList.remove("active"))},escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML},getCurrentChat(){return{type:this.currentChatType,id:this.currentChatId}},showRecordingModal(e){this.recordingModal&&(this.recordingModal.classList.add("active"),this.recordingModalTime.textContent="0:00",this.recordingChatType.textContent=e?"Chat grupal":"Chat individual")},hideRecordingModal(){this.recordingModal&&this.recordingModal.classList.remove("active")},updateRecordingModalTime(e){if(this.recordingModalTime){const t=Math.floor(e/60),n=e%60;this.recordingModalTime.textContent=`${t}:${n.toString().padStart(2,"0")}`}},showRecordingIndicator(){this.recordingIndicator&&this.recordingIndicator.classList.remove("hidden")},hideRecordingIndicator(){this.recordingIndicator&&this.recordingIndicator.classList.add("hidden")},updateRecordingTime(e){const t=document.getElementById("recording-time");if(t){const n=Math.floor(e/60),s=e%60;t.textContent=`${n}:${s.toString().padStart(2,"0")}`}},showIncomingCallModal(e,t=!1,n=[]){this.callerNameElement&&(this.callerNameElement.textContent=e),this.callAvatarLargeElement&&(this.callAvatarLargeElement.textContent=e.charAt(0).toUpperCase()),t&&n.length>0&&this.renderCallMembers(n,this.incomingCallModal),this.incomingCallModal&&this.incomingCallModal.classList.add("active")},hideIncomingCallModal(){this.incomingCallModal&&this.incomingCallModal.classList.remove("active")},showActiveCallModal(e,t=!1,n=[]){this.callTitleElement&&(this.callTitleElement.textContent=t?`Llamada Grupal: ${e}`:e),this.callAvatarLargeElement&&(this.callAvatarLargeElement.textContent=e.charAt(0).toUpperCase()),t&&n.length>0&&this.renderCallMembers(n,this.activeCallModal),this.activeCallModal&&this.activeCallModal.classList.add("active")},hideActiveCallModal(){this.activeCallModal&&this.activeCallModal.classList.remove("active")},updateCallDuration(e){if(this.callDurationElement){const t=Math.floor(e/60),n=e%60;this.callDurationElement.textContent=`${t}:${n.toString().padStart(2,"0")}`}},renderCallMembers(e,t){if(!t)return;let n=t.querySelector(".call-members-list");if(!n){n=document.createElement("div"),n.className="call-members-list";const e=t.querySelector(".call-modal-body");e&&e.appendChild(n)}n.innerHTML="",e.forEach(e=>{const t=document.createElement("div");t.className="call-member-item";const s=document.createElement("div");s.className="call-member-avatar",s.textContent=e.charAt(0).toUpperCase();const a=document.createElement("div");a.className="call-member-name",a.textContent=e;const l=document.createElement("div");l.className="call-member-status",l.textContent="En llamada",t.appendChild(s),t.appendChild(a),t.appendChild(l),n.appendChild(t)})},updateGroupCallMembers(e){this.activeCallModal&&this.activeCallModal.classList.contains("active")&&this.renderCallMembers(e,this.activeCallModal)}};"undefined"!=typeof window?(window.UI=UI,console.log("‚úÖ UI registrado globalmente")):console.error("‚ùå Window no est√° definido");