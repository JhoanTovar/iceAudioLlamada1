const API_BASE_URL=`http://${window.location.hostname}:3001/api`;let sessionId=null,currentUser=null,pollingInterval=null;const axiosInstance=window.axios.create({baseURL:API_BASE_URL,timeout:1e4,headers:{"Content-Type":"application/json"}});axiosInstance.interceptors.request.use(s=>(sessionId&&!s.skipAuth&&(s.headers["session-id"]=sessionId),s),s=>Promise.reject(s)),axiosInstance.interceptors.response.use(s=>s.data,s=>{throw console.error("Axios error:",s.response?.data||s.message),new Error(s.response?.data?.error||s.message)});const API={async register(s){const e=await axiosInstance.post("/register",{username:s},{skipAuth:!0});return e.success&&(sessionId=e.sessionId,currentUser=e.user,this.startPolling()),e},async login(s){const e=await axiosInstance.post("/login",{username:s},{skipAuth:!0});return e.success&&(sessionId=e.sessionId,currentUser=e.user,this.startPolling()),e},async logout(){this.stopPolling();const s=await axiosInstance.post("/logout",{sessionId});return sessionId=null,currentUser=null,s},startPolling(){console.log("Iniciando polling de mensajes..."),this.stopPolling(),pollingInterval=setInterval(async()=>{const s=window.UI.getCurrentChat();if(s.type&&s.id)try{let e;if(e="user"===s.type?await this.getHistory(s.id):await this.getGroupMessages(s.id),e.success){const s=e.currentUserId||this.getCurrentUser()?.id;window.UI.renderMessages(e.messages,s)}}catch(s){console.error("Error en polling:",s)}},2e3)},stopPolling(){pollingInterval&&(console.log("Deteniendo polling..."),clearInterval(pollingInterval),pollingInterval=null)},getUsers:async()=>await axiosInstance.get("/users"),async loadUsers(){try{console.log("Iniciando carga de usuarios...");const s=await this.getUsers();if(console.log("Respuesta de getUsers():",s),s.success&&s.users){console.log("Usuarios recibidos:",s.users.length,s.users);const e=s.users.map(s=>{if("string"==typeof s){console.warn("Usuario recibido como string:",s);try{const e=JSON.parse(s);return{id:e.id||null,username:e.username||s,online:e.online||!1}}catch{return{id:null,username:s,online:!1}}}return{id:s.id,username:s.username||s.name||"Usuario",online:s.online||!1}});return window.UI.allUsers=e,console.log("UI.allUsers actualizado con",window.UI.allUsers.length,"usuarios"),e}throw new Error(s.error||"No se recibieron usuarios")}catch(s){throw console.error("Error en loadUsers:",s),s}},async sendMessage(s,e){console.log("API.sendMessage llamado:",{receiverId:s,content:e});const o=await axiosInstance.post("/messages/send",{sessionId,receiverId:s,content:e});return console.log("API.sendMessage resultado:",o),o},async getHistory(s){console.log("API.getHistory llamado para userId:",s);try{const e=await axiosInstance.get(`/messages/history/${s}`);if(console.log("API.getHistory resultado RAW:",e),!e.success)throw new Error(e.error||"No se pudo obtener el historial");const o=this.getCurrentUser();let r=[];return Array.isArray(e.messages)?r=e.messages:e.messages&&"object"==typeof e.messages&&(r=Object.values(e.messages)),console.log("API.getHistory messagesArray procesado:",r),{success:!0,messages:r,currentUserId:o?.id||null}}catch(s){return console.error("Error en getHistory:",s),{success:!1,error:s.message,messages:[]}}},createGroup:async s=>await axiosInstance.post("/groups/create",{sessionId,groupName:s}),getGroups:async()=>await axiosInstance.get("/groups"),sendGroupMessage:async(s,e)=>(console.log("Enviando mensaje de grupo:",{groupId:s,content:e}),await axiosInstance.post("/messages/send-group",{sessionId,groupId:s,content:e})),async getGroupMessages(s){console.log("API.getGroupMessages llamado para groupId:",s);try{const e=await axiosInstance.get(`/messages/group/${s}`);if(console.log("API.getGroupMessages resultado RAW:",e),!e.success)throw new Error(e.error||"No se pudo obtener mensajes del grupo");const o=this.getCurrentUser();let r=[];return Array.isArray(e.messages)?r=e.messages:e.messages&&"object"==typeof e.messages&&(r=Object.values(e.messages)),console.log("API.getGroupMessages messagesArray procesado:",r),{success:!0,messages:r,currentUserId:o?.id||null}}catch(s){return console.error("Error en getGroupMessages:",s),{success:!1,error:s.message,messages:[]}}},addMemberToGroup:async(s,e)=>await axiosInstance.post("/groups/add-member",{sessionId,groupId:s,userId:e}),async addMembersToGroup(s,e){try{console.log("Agregando miembros:",e,"al grupo:",s);const o=await Promise.allSettled(e.map(e=>this.addMemberToGroup(s,e))),r=o.filter(s=>"fulfilled"===s.status&&s.value.success),a=o.filter(s=>"rejected"===s.status||!s.value.success);if(r.length===e.length)return console.log("Todos los miembros agregados exitosamente"),{success:!0};if(r.length>0)return console.warn("Algunos miembros no se agregaron:",a),{success:!0,partial:!0,message:`${r.length} de ${e.length} miembros agregados`};throw new Error("No se pudo agregar ningÃºn miembro")}catch(s){throw console.error("Error agregando miembros:",s),s}},async showAddMembersModal(s){try{console.log("showAddMembersModal llamado para grupo:",s),console.log("Estado inicial de UI.allUsers:",window.UI.allUsers?.length||0),console.log("Cargando usuarios...");const e=await this.loadUsers();if(console.log("Usuarios cargados exitosamente:",e?.length||0),!window.UI.allUsers||0===window.UI.allUsers.length)throw new Error("No se pudieron cargar los usuarios disponibles");window.UI.showAddMembersModal(s)}catch(s){console.error("Error en showAddMembersModal:",s),alert("Error cargando usuarios disponibles: "+s.message)}},healthCheck:async()=>await axiosInstance.get("/health",{skipAuth:!0}),async saveAudioMessage(s,e){console.log("Guardando mensaje de audio en backend:",{receiverId:s,duration:e});try{const o=await axiosInstance.post("/messages/send-audio",{sessionId,receiverId:parseInt(s),duration:parseInt(e)});return console.log("Audio guardado:",o),o}catch(s){throw console.error("Error guardando audio:",s),s}},async saveGroupAudioMessage(s,e){console.log("Guardando mensaje de audio grupal en backend:",{groupId:s,duration:e});try{const o=await axiosInstance.post("/messages/send-group-audio",{sessionId,groupId:parseInt(s),duration:parseInt(e)});return console.log("Audio grupal guardado:",o),o}catch(s){throw console.error("Error guardando audio grupal:",s),s}},async endCall(){console.log("Notificando fin de llamada al backend");try{const s=await axiosInstance.post("/calls/end",{sessionId});return console.log("Llamada registrada en backend:",s),s}catch(s){throw console.error("Error registrando llamada:",s),s}},getSessionId:()=>sessionId,getCurrentUser:()=>currentUser};"undefined"!=typeof window&&(window.API=API);