(()=>{"use strict";const e={recordingStartTime:null,recordingInterval:null,callDurationInterval:null,iceReady:!1,isRecordingAudioMessage:!1,async init(){console.log("------ Initializing chat application... ------"),await this.waitForIceDelegate(),window.UI.init(),this.connectICEtoAudioManager(),this.setupLoginListeners(),this.setupChatListeners(),this.setupModalListeners(),this.setupAudioListeners(),this.setupICECallbacks(),console.log(" Application initialized ")},async waitForIceDelegate(){let e=0;for(;!window.IceDelegate&&e<50;)await new Promise(e=>setTimeout(e,100)),e++;window.IceDelegate?(console.log(" IceDelegate cargado correctamente"),this.iceReady=!0):(console.error("IceDelegate no se pudo cargar"),alert("Error: No se pudo cargar el sistema de llamadas ICE"))},connectICEtoAudioManager(){window.IceDelegate&&window.AudioManager&&(window.IceDelegate.subscribe(e=>{console.log(" [ICE] Audio individual recibido, bytes:",e.length),window.AudioManager.playAudio(e)}),window.getCurrentGroupId=()=>window.UI.currentGroup?`group_${window.UI.currentGroup.id}`:null,console.log("ICE conectado con AudioManager"))},subscribeToGroup(e){const o=`group_${e}`;return!(!window.IceDelegate||!window.AudioManager||(console.log(` [ICE] Suscribi茅ndose a grupo: ${o}`),window.IceDelegate.subscribeGroup(o,e=>{console.log(` [ICE] Audio grupal recibido del grupo ${o}, bytes:`,e.length),window.AudioManager.playAudio(e)}),0))},unsubscribeFromGroup(e){const o=`group_${e}`;window.IceDelegate&&(console.log(` [ICE] Cancelando suscripci贸n a grupo: ${o}`),window.IceDelegate.groupCallbacks.has(o)&&window.IceDelegate.groupCallbacks.delete(o))},setupICECallbacks(){window.IceDelegate?(window.IceDelegate.onIncomingCall(e=>{console.log(" Llamada individual entrante de:",e),window.AudioManager&&(window.AudioManager.currentCall={id:`call_${Date.now()}`,callerId:e,callerName:e,startTime:Date.now(),type:"incoming",isGroup:!1}),window.UI.showIncomingCallModal(e,!1)}),window.IceDelegate.onCallAccepted(async e=>{console.log("Llamada aceptada por:",e),window.AudioManager&&(window.AudioManager.currentCall={id:`call_${Date.now()}`,recipientId:e,recipientName:e,startTime:Date.now(),isGroup:!1},await window.AudioManager.startLiveRecording()),window.UI.showActiveCallModal(e,!1),this.startCallDurationTimer()}),window.IceDelegate.onCallRejected(e=>{console.log("Llamada rechazada por:",e),window.AudioManager&&(window.AudioManager.stopLiveRecording(),window.AudioManager.currentCall=null),window.UI.hideActiveCallModal(),window.UI.hideIncomingCallModal(),alert(`${e} rechaz贸 la llamada`)}),window.IceDelegate.onCallEnded(e=>{console.log(" Llamada colgada por:",e),this.cleanupCall(),alert(`La llamada fue terminada por ${e}`)}),window.IceDelegate.onIncomingGroupCall((e,o,n)=>{console.log("Llamada grupal entrante:",e,"de:",o),window.AudioManager&&(window.AudioManager.currentCall={id:`group_call_${Date.now()}`,groupId:e,callerId:o,callerName:o,members:n,startTime:Date.now(),type:"incoming",isGroup:!0}),window.UI.showIncomingCallModal(`Grupo (${o})`,!0,n)}),window.IceDelegate.onGroupUpdated((e,o)=>{console.log("Grupo actualizado:",e,o),window.UI.updateGroupCallMembers(o)}),window.IceDelegate.onGroupEnded(e=>{console.log("Llamada grupal terminada:",e),this.cleanupCall(),alert("La llamada grupal ha terminado")}),console.log(" ICE callbacks configurados")):console.error("IceDelegate no disponible para callbacks")},setupLoginListeners(){window.UI.loginBtn.addEventListener("click",()=>this.handleLogin()),window.UI.registerBtn.addEventListener("click",()=>this.handleRegister()),window.UI.usernameInput.addEventListener("keypress",e=>{"Enter"===e.key&&this.handleLogin()})},setupChatListeners(){window.UI.logoutBtn.addEventListener("click",()=>this.handleLogout()),window.UI.sendBtn.addEventListener("click",()=>this.handleSendMessage()),window.UI.messageInput.addEventListener("keypress",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.handleSendMessage())});const e=document.getElementById("refresh-users-btn");e&&e.addEventListener("click",()=>this.loadUsers());const o=document.getElementById("create-group-btn");o&&o.addEventListener("click",()=>window.UI.showModal())},setupAudioListeners(){window.UI.sendAudioBtn&&window.UI.sendAudioBtn.addEventListener("click",async()=>{if(this.isRecordingAudioMessage)return;const e=window.UI.getCurrentChat();e.type&&e.id?await window.AudioManager.initAudio()&&(this.isRecordingAudioMessage=!0,this.recordingStartTime=Date.now(),await window.AudioManager.startRecordingMessage(),window.UI.showRecordingModal("group"===e.type),this.recordingInterval=setInterval(()=>{const e=Math.floor((Date.now()-this.recordingStartTime)/1e3);window.UI.updateRecordingModalTime(e)},100)):alert("Por favor selecciona un chat primero")});const e=document.getElementById("stop-recording-btn");e&&e.addEventListener("click",async()=>{await this.handleStopRecording()});const o=document.getElementById("cancel-recording-btn");o&&o.addEventListener("click",()=>{this.handleCancelRecording()}),window.UI.callBtn&&window.UI.callBtn.addEventListener("click",()=>this.handleInitiateCall()),window.UI.rejectCallBtn&&window.UI.rejectCallBtn.addEventListener("click",()=>this.handleRejectCall()),window.UI.answerCallBtn&&window.UI.answerCallBtn.addEventListener("click",()=>this.handleAnswerCall()),window.UI.endCallBtn&&window.UI.endCallBtn.addEventListener("click",()=>this.handleEndCall()),window.UI.muteBtn&&window.UI.muteBtn.addEventListener("click",()=>this.handleToggleMute())},async handleStopRecording(){if(!this.isRecordingAudioMessage)return;clearInterval(this.recordingInterval),this.isRecordingAudioMessage=!1;const e=await window.AudioManager.stopRecordingMessage();if(window.UI.hideRecordingModal(),!e||!e.pcm16)return void alert("Error al grabar audio");const o=window.UI.getCurrentChat(),n=window.API.getCurrentUser();try{let a=!1;if("user"===o.type){const r=window.UI.allUsers.find(e=>e.id===o.id);if(!r)return void alert("Usuario no encontrado");a=await window.IceDelegate.sendAudioMessage(r.username,e.pcm16),console.log("Mensaje de audio individual enviado por ICE a:",r.username);try{await window.API.saveAudioMessage(o.id,e.duration),console.log("Audio guardado en backend")}catch(e){console.error("Error guardando audio en backend:",e)}window.UI.appendAudioMessage({senderId:n.id,timestamp:(new Date).toISOString(),duration:e.duration,type:"AUDIO"},n.id),setTimeout(async()=>{await this.loadMessages("group",o.id)},500)}else if("group"===o.type){const r=window.UI.currentGroup;if(!r)return void alert("Grupo no encontrado");const i=(r.memberIds||r.members||[]).map(e=>{const o="object"==typeof e?e.id:e;console.log(` Buscando miembro con ID: ${o}`);const n=window.UI.allUsers.find(e=>e.id===o);return n||console.warn(`锔 Usuario no encontrado con ID: ${o}`),n?.username||null}).filter(e=>null!==e),t=`group_${r.id}`;if(!await window.IceDelegate.joinMessagingGroup(t,i))return void alert("No se pudo crear/acceder al grupo ICE");a=await window.IceDelegate.sendAudioMessageGroup(t,e.pcm16),console.log("Mensaje de audio grupal enviado por ICE a:",t);try{await window.API.saveGroupAudioMessage(o.id,e.duration),console.log("Audio grupal guardado en backend")}catch(e){console.error("Error guardando audio grupal en backend:",e)}window.UI.appendAudioMessage({senderId:n.id,timestamp:(new Date).toISOString(),duration:e.duration,type:"AUDIO"},n.id),setTimeout(async()=>{await window.AppController.loadMessages("group",o.id)},500)}a||alert("Error al enviar mensaje de audio")}catch(e){console.error("Error enviando mensaje de audio:",e),alert("Error al enviar mensaje de audio")}},handleCancelRecording(){this.isRecordingAudioMessage&&(clearInterval(this.recordingInterval),this.isRecordingAudioMessage=!1,window.AudioManager.cancelRecordingMessage(),window.UI.hideRecordingModal(),console.log("Grabaci贸n cancelada"))},async handleInitiateCall(){const e=window.UI.getCurrentChat();if(e.type&&e.id)try{if("user"===e.type){const o=window.UI.allUsers.find(o=>o.id===e.id);if(!o)return void alert("Usuario no encontrado");await window.IceDelegate.startCall(o.username)?(window.AudioManager.currentCall={id:`call_${Date.now()}`,recipientId:o.username,recipientName:o.username,startTime:Date.now(),isGroup:!1},window.UI.showActiveCallModal(o.username,!1),console.log("Llamada individual iniciada con:",o.username)):alert("No se pudo iniciar la llamada")}else if("group"===e.type){const e=window.UI.currentGroup;if(!e)return void alert("Grupo no encontrado");const o=(e.memberIds||e.members||[]).map(e=>{const o=window.UI.allUsers.find(o=>o.id===e);return o?o.username:null}).filter(e=>null!==e),n=await window.IceDelegate.createGroupCall(o);n?(window.AudioManager.currentCall={id:`group_call_${Date.now()}`,groupId:n,members:o,startTime:Date.now(),isGroup:!0},await window.AudioManager.startLiveRecording(),window.UI.showActiveCallModal(e.name||"Grupo",!0,o),console.log("Llamada grupal iniciada:",n)):alert("No se pudo iniciar la llamada grupal")}}catch(e){console.error("Error al iniciar llamada:",e),alert("Error al iniciar la llamada")}else alert("Por favor selecciona un usuario o grupo primero")},async handleRejectCall(){const e=window.AudioManager.currentCall;e&&(e.isGroup?await window.AudioManager.rejectGroupCall(e.groupId):await window.AudioManager.rejectCall(e.callerId),window.UI.hideIncomingCallModal(),console.log("Llamada rechazada"))},async handleAnswerCall(){try{const e=window.AudioManager.currentCall;if(!e)return void alert("No hay llamada entrante");let o=!1;e.isGroup?(o=await window.AudioManager.answerGroupCall(e.groupId),o&&(window.UI.hideIncomingCallModal(),window.UI.showActiveCallModal(e.callerName,!0,e.members),this.startCallDurationTimer(),console.log("Llamada grupal respondida"))):(o=await window.AudioManager.answerCall(e.callerId),o&&(window.UI.hideIncomingCallModal(),window.UI.showActiveCallModal(e.callerName,!1),this.startCallDurationTimer(),console.log("Llamada individual respondida"))),o||alert("No se pudo responder la llamada")}catch(e){console.error("Error al responder llamada:",e),alert("Error al responder la llamada")}},async handleEndCall(){if(window.AudioManager.currentCall){await window.AudioManager.endCall(),this.cleanupCall();try{await window.API.endCall(),console.log("Llamada registrada en backend")}catch(e){console.error("Error registrando llamada en backend:",e)}console.log(" Llamada terminada")}},handleToggleMute(){if(window.UI.muteBtn&&window.AudioManager.mediaStream){const e=window.AudioManager.mediaStream.getAudioTracks(),o=!1===e[0]?.enabled;e.forEach(e=>{e.enabled=!o}),window.UI.muteBtn.style.opacity=o?"1":"0.5",console.log(o?" Micr贸fono activado":"Micr贸fono silenciado")}},startCallDurationTimer(){let e=0;this.callDurationInterval=setInterval(()=>{e++,window.UI.updateCallDuration(e)},1e3)},cleanupCall(){window.AudioManager&&(window.AudioManager.stopLiveRecording(),window.AudioManager.currentCall=null),this.callDurationInterval&&(clearInterval(this.callDurationInterval),this.callDurationInterval=null),window.UI.hideActiveCallModal()},setupModalListeners(){window.UI.confirmGroupBtn.addEventListener("click",()=>this.handleCreateGroup()),window.UI.cancelGroupBtn.addEventListener("click",()=>window.UI.closeModal()),window.UI.groupNameInput.addEventListener("keypress",e=>{"Enter"===e.key&&this.handleCreateGroup()}),window.UI.confirmMembersBtn.addEventListener("click",()=>this.handleAddMembers()),window.UI.cancelMembersBtn.addEventListener("click",()=>window.UI.closeAddMembersModal())},async handleLogin(){const e=window.UI.usernameInput.value.trim();if(e)if(this.iceReady)try{if(window.UI.loginBtn.disabled=!0,window.UI.loginBtn.textContent="Conectando...",!await window.IceDelegate.init(e))throw new Error("No se pudo conectar al servidor ICE");console.log("Conectado al servidor ICE como:",e);const o=await window.API.login(e);if(!o.success)throw new Error(o.error||"Error al iniciar sesi贸n");await this.onLoginSuccess()}catch(e){console.error("Login error:",e),window.UI.showError(window.UI.loginError,e.message||"Error al iniciar sesi贸n")}finally{window.UI.loginBtn.disabled=!1,window.UI.loginBtn.textContent="Iniciar Sesi贸n"}else window.UI.showError(window.UI.loginError,"Sistema ICE no est谩 listo. Recarga la p谩gina.");else window.UI.showError(window.UI.loginError,"Por favor ingresa un nombre de usuario")},async handleRegister(){const e=window.UI.usernameInput.value.trim();if(e)if(this.iceReady)try{if(window.UI.registerBtn.disabled=!0,window.UI.registerBtn.textContent="Registrando...",!await window.IceDelegate.init(e))throw new Error("No se pudo conectar al servidor ICE");const o=await window.API.register(e);if(!o.success)throw new Error(o.error||"Error al registrarse");console.log("Registration successful:",o.user.username),await this.onLoginSuccess()}catch(e){console.error("Registration error:",e),window.UI.showError(window.UI.loginError,e.message||"Error al registrarse")}finally{window.UI.registerBtn.disabled=!1,window.UI.registerBtn.textContent="Registrarse"}else window.UI.showError(window.UI.loginError,"Sistema ICE no est谩 listo. Recarga la p谩gina.");else window.UI.showError(window.UI.loginError,"Por favor ingresa un nombre de usuario")},async onLoginSuccess(){const e=window.API.getCurrentUser();window.UI.setCurrentUser(e),window.UI.showChatScreen(),await this.loadUsers(),await this.loadGroups(),window.AudioManager&&(await window.AudioManager.initAudio()?console.log("AudioManager inicializado para reproducir audios entrantes"):console.warn("No se pudo inicializar AudioManager al iniciar sesi贸n"))},async handleLogout(){try{await window.API.logout(),console.log("Logged out successfully"),window.UI.showLoginScreen()}catch(e){console.error("Logout error:",e),window.UI.showLoginScreen()}},async loadUsers(){try{const e=await window.API.getUsers();if(e.success){const o=window.API.getCurrentUser();window.UI.renderUsers(e.users,o.id),console.log("Usuarios cargados:",window.UI.allUsers.length)}}catch(e){console.error("Error loading users:",e)}},async loadGroups(){try{const e=await window.API.getGroups();e.success&&(window.UI.renderGroups(e.groups),console.log("Grupos cargados:",e.groups.length))}catch(e){console.error("Error loading groups:",e)}},async handleCreateGroup(){const e=window.UI.groupNameInput.value.trim();if(e)try{window.UI.confirmGroupBtn.disabled=!0,window.UI.confirmGroupBtn.textContent="Creando...";const o=await window.API.createGroup(e);o.success&&(console.log("Group created:",o.group.name),window.UI.closeModal(),await this.loadGroups())}catch(e){console.error("Error creating group:",e),window.UI.showError(window.UI.groupError,e.message||"Error al crear el grupo")}finally{window.UI.confirmGroupBtn.disabled=!1,window.UI.confirmGroupBtn.textContent="Crear Grupo"}else window.UI.showError(window.UI.groupError,"Por favor ingresa un nombre para el grupo")},async handleAddMembers(){const e=window.UI.getSelectedMembers();if(0!==e.length)try{if(window.UI.confirmMembersBtn.disabled=!0,window.UI.confirmMembersBtn.textContent="Agregando...",window.UI.hideError(window.UI.membersError),await window.API.addMembersToGroup(window.UI.currentGroup.id,e),await this.loadGroups(),"group"===window.UI.currentChatType&&window.UI.currentChatId===window.UI.currentGroup.id){const e=await window.API.getGroups();if(e.success){const o=e.groups.find(e=>e.id===window.UI.currentGroup.id);o&&window.UI.openGroupChat(o)}}window.UI.closeAddMembersModal()}catch(e){console.error("Error adding members:",e),window.UI.showError(window.UI.membersError,e.message||"Error al agregar miembros")}finally{window.UI.confirmMembersBtn.disabled=!1,window.UI.confirmMembersBtn.textContent="Agregar"}else window.UI.showError(window.UI.membersError,"Por favor selecciona al menos un usuario")},async handleSendMessage(){const e=window.UI.messageInput.value.trim();if(!e)return;const o=window.UI.getCurrentChat();if(o.type&&o.id)try{let n;window.UI.sendBtn.disabled=!0,n="user"===o.type?await window.API.sendMessage(o.id,e):await window.API.sendGroupMessage(o.id,e),n.success&&(window.UI.clearMessageInput(),await this.loadMessages(o.type,o.id))}catch(e){console.error("Error sending message:",e),alert("Error al enviar el mensaje: "+e.message)}finally{window.UI.sendBtn.disabled=!1}else alert("Por favor selecciona un usuario o grupo primero")},async loadMessages(e,o){try{let n;if(n="user"===e?await window.API.getHistory(o):await window.API.getGroupMessages(o),n.success){const e=window.API.getCurrentUser(),o=Array.isArray(n.messages)?n.messages:Object.values(n.messages||{});window.UI.renderMessages(o,e.id)}}catch(e){console.error("Error loading messages:",e)}},openUserChat(e){this.openUserChatAndLoadHistory(e)},openGroupChat(e){this.openGroupChatAndLoadHistory(e)},async openUserChatAndLoadHistory(e){window.UI.currentChatType="user",window.UI.currentChatId=e.id,window.UI.currentGroup=null,window.UI.previousGroupId&&this.unsubscribeFromGroup(window.UI.previousGroupId),window.UI.welcomeScreen.style.display="none",window.UI.chatArea.classList.remove("hidden"),window.UI.chatTitle.textContent=e.username,window.UI.chatSubtitle.textContent=e.online?"En l铆nea":"Desconectado";const o=document.querySelector(".chat-avatar");o&&(o.textContent=e.username.charAt(0).toUpperCase());const n=document.getElementById("group-info-btn");n&&(n.style.display="none"),window.UI.messagesContainer.innerHTML="",document.querySelectorAll("#users-list .list-item").forEach(e=>{e.classList.remove("active")});const a=document.querySelector(`#users-list .list-item[data-user-id="${e.id}"]`);a&&a.classList.add("active"),await this.loadMessages("user",e.id)},async openGroupChatAndLoadHistory(e){window.UI.currentChatType="group",window.UI.currentChatId=e.id,window.UI.currentGroup=e;try{const o=(e.memberIds||e.members||[]).map(e=>{const o=window.UI.allUsers.find(o=>o.id===e);return o?o.username:null}).filter(e=>null!==e);console.log(`[ICE] Creando/Uni茅ndose al grupo ICE: group_${e.id}`),console.log("[ICE] Miembros:",o);const n=await window.IceDelegate.createGroupCall(o);console.log(`[ICE] Grupo creado en ICE: ${n}`)}catch(e){console.error("[ICE] Error creando grupo ICE:",e)}window.UI.welcomeScreen.style.display="none",window.UI.chatArea.classList.remove("hidden");const o=e.name||e.groupName||"Grupo";window.UI.chatTitle.textContent=o;const n=e.memberIds&&e.memberIds.length||e.members&&e.members.length||0;window.UI.chatSubtitle.textContent=`${n} miembro${1!==n?"s":""}`;const a=document.querySelector(".chat-avatar");a&&(a.textContent=o.charAt(0).toUpperCase());const r=document.getElementById("group-info-btn");r&&(r.style.display="flex",r.onclick=()=>window.API.showAddMembersModal(e)),window.UI.messagesContainer.innerHTML="",document.querySelectorAll("#groups-list .list-item").forEach(e=>{e.classList.remove("active")});const i=document.querySelector(`#groups-list .list-item[data-group-id="${e.id}"]`);i&&i.classList.add("active"),await this.loadMessages("group",e.id)}};document.addEventListener("DOMContentLoaded",()=>{e.init()}),document.addEventListener("click",async o=>{const n=o.target.closest("#users-list .list-item"),a=o.target.closest("#groups-list .list-item");if(n){const o=Number.parseInt(n.dataset.userId);await e.loadMessages("user",o)}else if(a){const o=Number.parseInt(a.dataset.groupId);window.UI.currentChatId=o,await e.loadMessages("group",o)}})})();