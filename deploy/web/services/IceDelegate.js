import Subscriber from"./subscriber.js";class IceDelegate{constructor(){this.communicator=null,this.subject=null,this.name=null,this.currentCall=null,this.subscriber=null,this.callbacks=[],this.groupCallbacks=new Map,this.groupUsersUpdatedCB=null,this.incomingCallCB=null,this.callAcceptedCB=null,this.callRejectedCB=null,this.callColgadaCB=null,this.incomingGroupCallCB=null,this.groupUpdatedCB=null,this.groupEndedCB=null,this.isInitialized=!1}async init(e){if(this.name=e,this.subject)return console.log(" IceDelegate ya estaba inicializado"),!0;try{console.log(" Inicializando Ice.Communicator..."),this.communicator=Ice.initialize(),console.log(" Conectando al proxy...");const e=this.communicator.stringToProxy(`AudioService:ws -h ${window.location.hostname} -p 9099`);if(console.log(" Casteando a SubjectPrx..."),this.subject=await Demo.SubjectPrx.checkedCast(e),!this.subject)return console.error(" No pude castear SubjectPrx"),!1;console.log(" Creando adapter...");const t=await this.communicator.createObjectAdapter("");await t.activate(),this.subject.ice_getCachedConnection().setAdapter(t),console.log(" Creando subscriber..."),this.subscriber=new Subscriber(this);const r=Demo.ObserverPrx.uncheckedCast(t.addWithUUID(this.subscriber));return console.log("Registrando con el servidor..."),await this.subject.attach(this.name,r),this.isInitialized=!0,console.log("ICE Delegate listo como:",this.name),!0}catch(e){return console.error(" Error inicializando IceDelegate:",e),!1}}startHeartbeat(){this.heartbeatInterval=setInterval(async()=>{if(!this.subject)return console.warn(" Conexión ICE perdida"),void this.reconnect();try{await this.subject.ice_ping()}catch(e){console.error(" Heartbeat falló:",e),this.reconnect()}},5e3)}async reconnect(){console.log(" Intentando reconectar..."),clearInterval(this.heartbeatInterval),this.isInitialized=!1,this.subject=null,await this.init(this.name)&&(console.log(" Reconexión exitosa"),window.AppController&&window.AppController.setupICECallbacks())}async getUsers(){if(!this.subject)return[];try{return await this.subject.getConnectedUsers()}catch(e){return console.error("Error obteniendo usuarios:",e),[]}}async startCall(e){if(!this.subject)return console.error(" No hay conexión ICE"),!1;try{return console.log(`[ICE] Iniciando llamada a: ${e}`),await this.subject.startCall(this.name,e),this.currentCall=e,!0}catch(e){return console.error(" Error iniciando llamada:",e),!1}}async acceptCall(e){if(!this.subject)return!1;try{return console.log(`[ICE] Aceptando llamada de: ${e}`),await this.subject.acceptCall(e,this.name),this.currentCall=e,!0}catch(e){return console.error(" Error aceptando llamada:",e),!1}}async rejectCall(e){if(!this.subject)return!1;try{return console.log(`[ICE] Rechazando llamada de: ${e}`),await this.subject.rejectCall(e,this.name),!0}catch(e){return console.error(" Error rechazando llamada:",e),!1}}async colgar(e){if(!this.subject)return!1;try{return console.log(`[ICE] Colgando con: ${e}`),await this.subject.colgar(this.name,e),this.currentCall===e&&(this.currentCall=null),!0}catch(e){return console.error(" Error colgando:",e),!1}}async sendAudio(e){if(!this.subject)return console.error(" No hay subject"),!1;try{const t=Uint8Array.from(e);return await this.subject.sendAudio(this.name,t),!0}catch(e){return console.error(" Error enviando audio:",e),!1}}async sendAudioMessage(e,t){if(!this.subject)return console.error(" No hay subject"),!1;try{const r=Uint8Array.from(t);return console.log(`[ICE] Enviando mensaje de audio a: ${e}, bytes: ${r.length}`),await this.subject.sendAudioMessage(this.name,e,r),!0}catch(e){return console.error(" Error enviando mensaje de audio:",e),!1}}async createGroupCall(e){if(!this.subject)return console.error("No hay subject"),!1;try{const t=e.filter(e=>e!==this.name);console.log("[ICE] Creando llamada grupal con usuarios:",t);const r=await this.subject.createGroupCall(this.name,t);return console.log(`[ICE] Llamada grupal creada con ID: ${r}`),await this.joinGroupCall(r),r}catch(e){return console.error(" Error creando llamada grupal:",e),!1}}async joinGroupCall(e){if(!this.subject)return!1;try{return console.log(`[ICE] Uniéndose al grupo: ${e}`),await this.subject.joinGroupCall(e,this.name),this.name===this.subject.initiator||UI.hideIncomingCallModal(e),UI.showInCallScreen(e,this.name),!0}catch(e){return console.error("Error uniéndose a llamada grupal:",e),!1}}async leaveGroupCall(e){if(!this.subject)return!1;try{return console.log(`[ICE] Saliendo del grupo: ${e}`),await this.subject.leaveGroupCall(e,this.name),!0}catch(e){return console.error(" Error saliendo de llamada grupal:",e),!1}}async sendAudioGroup(e,t){if(!this.subject)return console.error(" No hay subject"),!1;try{const r=Uint8Array.from(t);return await this.subject.sendAudioGroup(e,this.name,r),!0}catch(e){return console.error(" Error enviando audio grupal:",e),!1}}async sendAudioMessageGroup(e,t){if(!this.subject)return!1;try{const r=Uint8Array.from(t);return await this.subject.sendAudioMessageGroup(this.name,e,r),!0}catch(e){return console.error("Error sendAudioMessageGroup:",e),!1}}async joinMessagingGroup(e,t){if(!this.subject)return!1;try{return await this.subject.joinMessagingGroup(e,t),!0}catch(e){return console.error("Error joinMessagingGroup:",e),!1}}onGroupUsersUpdated(e){this.groupUsersUpdatedCB=e}notifyGroupUsersUpdated(e,t){this.groupUsersUpdatedCB?.(e,t)}subscribe(e){this.callbacks.push(e)}notify(e){this.callbacks.forEach(t=>t(e))}subscribeGroup(e,t){this.groupCallbacks.has(e)||this.groupCallbacks.set(e,[]),this.groupCallbacks.get(e).push(t)}notifyGroupMessage(e,t){this.groupCallbacks.has(e)&&this.groupCallbacks.get(e).forEach(e=>e(t)),window.AudioManager?.playAudio&&window.AudioManager.playAudio(t)}onIncomingCall(e){this.incomingCallCB=e}onCallAccepted(e){this.callAcceptedCB=e}onCallRejected(e){this.callRejectedCB=e}onCallEnded(e){this.callColgadaCB=e}notifyIncomingCall(e){this.incomingCallCB&&this.incomingCallCB(e)}notifyCallAccepted(e){this.callAcceptedCB&&this.callAcceptedCB(e)}notifyCallRejected(e){this.callRejectedCB&&this.callRejectedCB(e)}notifyCallColgada(e){this.currentCall===e&&(this.currentCall=null),this.callColgadaCB&&this.callColgadaCB(e)}onIncomingGroupCall(e){this.incomingGroupCallCB=e}onGroupUpdated(e){this.groupUpdatedCB=e}onGroupEnded(e){this.groupEndedCB=e}notifyIncomingGroupCall(e,t,r){this.incomingGroupCallCB&&this.incomingGroupCallCB(e,t,r)}notifyGroupCallUpdated(e,t){this.groupUpdatedCB&&this.groupUpdatedCB(e,t)}notifyGroupCallEnded(e){this.groupEndedCB&&this.groupEndedCB(e)}}"undefined"!=typeof window?(console.log(" Creando instancia global de IceDelegate"),window.IceDelegate=new IceDelegate):console.error(" Window no está definido");